# 记一次 Mac 笔记本磁盘爆满后导致重启卡死的问题排查过程(是流水账 🦆)

## 问题背景

2021-04-16，这天是周五，下班回到家准备刷题，刚打开笔记本就收到一条磁盘爆满的通知，这我就纳闷了，笔记本总共有 500G 的存储空间，映像里没放多少很占空间的文件，怎么可能爆满呢？去磁盘管理一看，好家伙，500G 果然存得满满的。删了几个镜像文件，腾出来十几个 G 的空间，就想着按电脑问题解决三部曲来处理：

1. 重启软件
2. 重启电脑
3. 重装系统

很显然目前找不到是什么软件引起的问题，重启软件肯定解决不了问题，把所有的工作保存后就重启了电脑。可是没想到，噩梦从这里开始：

重新开机的时候卡在苹果 Logo 进度条的位置

平常的时候开机最多不过十秒，可我还是耐心地等了它长达两三分钟，进度条仍然保持不动。长按开机键把它强制关机了，再次开机。

但突然又想起苹果一次更新等一年的尿性，想着姑且再耐心等等吧，二十分钟过去了，进度条依然屹立不倒。这很不寻常，又不是更新系统，只是一次简单的重启，明显是电脑崩了啊。我承认开始慌了。

强制关机，再重启，等几分钟又重复，结果当然是没有任何改变。

谷歌，对！输入关键字查询到了一些方案：

1. `Option-Command-P-R`：重置 NVRAM 或 PRAM。在开机后按这些键保持 20 秒左右。
2. `Command-R`：intel cpu 的机子开机时按这俩键进入安全模式。M1 的机子是长按 shift 键。进入安全模式了就可以使用备份恢复、重装系统、磁盘管理等功能。

## 尝试解决

先通过长按 `Option-Command-P-R` 重置了 NVRAM，再次开机果然屏幕更亮了，一些基本设置回到了预设状态，说明重置成功了，但是，进度条还是卡住了，重复尝试了几次仍然没用。

进入安全模式，选择管理员账号，第一次来，也不知道能干啥，能明显感觉到的是显卡功能肯定受限了，画面不是很流畅。安全模式提供了四个功能，从时间机器恢复机器，重装系统，Safari，磁盘管理工具。

1. 时间机器恢复，平时没有备份的好习惯，行不通啊。

2. 重装系统，挺可以的啊，毕竟还是电脑问题解决三部曲的一种方案，当作备选吧。

3. Safari 浏览器，这能干个啥，方便我去查百度？有手机不是一样的吗，鸡肋！

4. 磁盘管理工具，就相信你了。

打开磁盘管理工具，首先找的就是如何进入类似 访达 的地方，找找看能不能再清理些文件。转了半天发现它根本就不提供文件浏览，能干的无非就是磁盘急救、磁盘抹除、磁盘恢复，抹除是不可能的，工作区还有很多文件没备份呢，恢复吧也用不到，难道我磁盘真坏了，需要急救？

照着教程依次把每个磁盘急救一下，都能显示急救成功！但重启后依然卡进度条。说明我磁盘并没有坏，这是个好消息。

再次回到安全模式，兜兜转转发现这里居然还提供一个简单的终端。这一次从终端成功进入了用户区，有着我熟悉的 Workplace、Desktop、Download 等文件夹。删了些东西，回到磁盘管理工具，这时已经有三十多个 G 的空间了，应该重启至少能让我进到桌面吧，求求了！

并没有用！

没办法了，看来只能启用终极解决办法--重装系统。但文件不能白白丢失啊，必须先备份，好在明天是周六不用工作，有时间折腾。在京东下了个单，买了移动硬盘，2T 空间的，有 USB-C 接口，Mac 可以直接用，就是贵了点 500 多块钱，勾选了京准达，预计周六上午九点至十一点直接送到。

## 终极解决大法

九点半收到移动硬盘，手感还不错，在安全模式连上也能直接用，不用作过多配置这几点必须好评。

无奈开始备份文件，首先是用户数据，把整个管理员账号的文件打包一下，不知道过去多久，打包完一看有八十多个 G，压缩过程中看到最多的就是 node_modules 的字眼，文件不大但巨多，前端同学懂得都懂！

拷贝到移动硬盘，据官方给出的这款移动机械硬盘的读写速度大概在 30-100MB 之间，粗略一算也得半个小时，随手计了时，真实拷贝完成就花了不到十五分钟时间，说明比官方标明的速度快了些，或许是电脑和硬盘都挺给力。

继续备份其他文件。

## 发现罪魁祸首

依次备份了 Users、Applications、System、Library 这些根目录下的大文件夹后，在接下来备份的 Privates 文件夹中发现了一些猫腻。

压缩 Privates 文件夹时发现一个 app.pasteNow.PasteNow 的文件夹里文件被压缩了好久，说明这个软件里的文件太多了，进入这个文件夹运行 ls 命令一直没反应。回到上一层目录，用 ls 查看这个文件夹的大小居然有 65M。

事出反常必有妖。要知道，ls 命令查看的是文件夹大小，就文件夹里放了一个 100G 的文件，ls 查看出来的文件夹大小也就 100B 以内，因为这个大小不是内部所有文件的大小总和，只有在内部存在嵌套文件夹或其他文件时，ls 得出来的大小才会按内部文件夹或文件的数量每个乘以 64B 左右加起来。

这里显示的是 65M，按内部一个文件夹或文件 64B 的大小计算，起码里边有超过百万个文件(夹)。

PasteNow 只是个简单的剪贴板软件啊，在 AppStore 里评价还不错，但我装的是盗版的（逃，也不至于是病毒，最后的猜测是这个软件优化不行，占用过多存储空间，或者是我无意间触发了这个软件的某个 Bug，导致它重复在我的缓冲区死循环地写入文件。

既然罪魁祸首找到了，那么事情就迎刃而解了。

rm -rf 大法启动！

一分钟过去了还没结束，这个命令删除大文件也是瞬间的事情，只有在遇到多文件时运行时间才会很长。

ls 查看 app.pasteNow.PasteNow 文件夹大小，只减少了不到 100K，这么算看来还得运行半小时到一个小时呢！我果然还是轻敌了。

## 泪目

时间已然来到中午，删除命令运行结束，我也成功进入到桌面。一切都是熟悉的味道。

迅速删除了 PasteNow 软件。

如释重负。

又能卷了。

## 尾声

1. 移动硬盘好像可以退货了，但还是算了吧，既然与我相遇必定是有缘分。
2. PasteNow，是个好软件，但我装的盗版的 1.0.0 版本，没法更新，而正版的软件在 1.1.0 已经优化了这个饱受诟病的占用存储空间过多的问题。所以，有能力的话（经济能力）多多支持正版吧。
3. 养成备份的好习惯，既然有了硬盘了，就可以给电脑每隔一段固定时间做一次备份，即便未来不管是硬件还是系统出了问题，能减少一定的损失。
4. 电脑问题解决三部曲还是很有效。
